# Ava Chat 集成 - 使用说明

## 功能概述

Ava 现在已经集成了 AI Chat 功能，可以作为浏览器自动化助手，通过对话界面与用户交互，分析页面元素并执行自动化操作。

## 核心功能

### 1. 对话界面

- 点击 Ava 浮动按钮打开/关闭对话框
- 支持拖拽移动按钮位置
- 消息历史自动保存（最多50条）
- 清除历史记录功能

### 2. 浏览器自动化

- 自动扫描页面可交互元素
- AI 理解用户需求并生成操作指令
- 执行点击、滚动、输入等操作
- 实时反馈操作结果

### 3. 智能交互

- 流式 AI 响应
- 操作执行状态提示
- 友好的错误处理
- 操作结果详细反馈

## 使用步骤

### 1. 配置 API Token

在使用 Ava 之前，需要先配置 AI 服务的 API Token：

1. 访问 [DZMM AI](https://www.dzmm.ai/profile?tab=api) 获取 Token（需翻墙）
2. 在 Chat 页面的菜单中点击"API Token"
3. 输入至少一个 Token 并保存

### 2. 使用 Ava

1. **打开对话框**

   - 点击页面右下角的 Ava 浮动按钮
   - 对话框会展开显示

2. **发送指令**

   - 在输入框中输入你的需求，例如：
     - "点击第一个图片"
     - "滚动到页面底部"
     - "点击登录按钮"
   - 按回车或点击"发送"按钮

3. **查看执行结果**

   - Ava 会显示"正在分析页面并思考..."
   - AI 分析完成后会执行相应操作
   - 操作结果会显示在对话中

4. **清除历史**
   - 点击对话框标题栏的垃圾桶图标
   - 确认后清除所有对话历史

## 工作原理

### 1. 页面扫描

- 使用 `getInteractables()` 扫描页面上的所有可交互元素
- 为每个元素分配唯一的 `data-agent-id`
- 提取元素的标签名、文本、类名等信息

### 2. AI 决策

- 将用户需求和元素列表发送给 AI
- AI 分析并返回 JSON 格式的操作指令
- 指令包含操作类型（click/scroll/input）和目标元素 ID

### 3. 操作执行

- 将 AI 指令转换为 ActionExecutor 可执行的操作
- 使用 `data-agent-id` 定位目标元素
- 执行操作并收集结果

### 4. 反馈生成

- 根据执行结果生成用户友好的反馈消息
- 显示成功/失败的操作详情
- 提供错误处理建议

## 示例对话

```
用户: 点击第一个按钮
Ava: 🤔 正在分析页面并思考...
Ava: ✅ 成功执行了 1 个操作：
     1. click - 点击第一个按钮

用户: 滚动到底部
Ava: 🤔 正在分析页面并思考...
Ava: ✅ 成功执行了 1 个操作：
     1. scroll - 滚动到页面底部
```

## 错误处理

Ava 会自动处理各种错误情况：

- **网络错误**: 提示检查网络连接
- **API 错误**: 提示检查 Token 配置
- **元素未找到**: 提示页面可能已更新
- **JSON 解析错误**: 提示重新描述需求
- **操作超时**: 提示检查页面状态

## 技术架构

### 核心模块

1. **AgentController** (`src/components/Ava/utils/AgentController.js`)

   - 协调整个 Agent 任务流程
   - 集成页面观察、AI 服务和操作执行

2. **Observe** (`src/components/Ava/utils/Observe.js`)

   - 扫描页面可交互元素
   - 分配唯一 ID 标识

3. **ActionExecutor** (`src/components/Ava/utils/ActExe.js`)

   - 执行具体的浏览器操作
   - 提供视觉反馈（高亮效果）

4. **ErrorHandler** (`src/components/Ava/utils/ErrorHandler.js`)
   - 统一的错误处理机制
   - 生成用户友好的错误消息

### 数据流

```
用户输入 → AgentController
         ↓
    页面扫描 (Observe)
         ↓
    构建 Prompt
         ↓
    AI 服务 (postDZMMAgent)
         ↓
    解析 JSON 响应
         ↓
    转换为 Action 对象
         ↓
    执行操作 (ActionExecutor)
         ↓
    生成反馈消息
         ↓
    显示在对话界面
```

## 注意事项

1. **API Token**: 必须先配置有效的 API Token 才能使用
2. **网络要求**: 需要能够访问 DZMM AI 服务（可能需要翻墙）
3. **页面兼容性**: 某些动态页面可能需要刷新后才能正确识别元素
4. **操作限制**: 某些操作可能被浏览器安全策略阻止
5. **历史记录**: 对话历史存储在本地，最多保留 50 条

## 故障排除

### 问题：Ava 无法响应

- 检查是否配置了 API Token
- 检查网络连接是否正常
- 查看浏览器控制台是否有错误信息

### 问题：找不到目标元素

- 刷新页面后重试
- 确保目标元素在当前视口内可见
- 尝试更具体地描述目标元素

### 问题：操作执行失败

- 检查页面是否已加载完成
- 确认目标元素是否可交互
- 查看错误消息中的具体原因

## 未来改进

- [ ] 支持更多操作类型（hover、drag、等待等）
- [ ] 添加操作录制和回放功能
- [ ] 支持自定义 Prompt 模板
- [ ] 添加操作历史记录和撤销功能
- [ ] 支持批量操作和条件判断
- [ ] 集成更多 AI 服务提供商
